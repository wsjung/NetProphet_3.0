Bootstrap: docker
From: ubuntu:18.04

%help
    Singularity container for running netprophet3 package
    Brent Lab, Washington University in Saint Louis


%environment
    export PATH=${PATH}:/home/opt/openmpi/bin:/home/packages_np3/meme/bin:/home/packages_np3/meme/libexec/meme-5.1.0:/home/packages_np3/FIRE-1.1a/
    export FIREDIR=/home/packages_np3/FIRE-1.1a
    export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/home/opt/openmpi/lib
    export R_LIBS_USER=${R_LIBS_USER}:/usr/local/lib/R/site-library
    export LC_ALL=C

%post
    # update OS
    apt-get update
    apt-get upgrade -y

    # ruby
    apt-get install ruby -y

    # python
    apt-get install python3.6 -y
    apt install python3-pip -y
    pip3 install pandas
    pip3 install numpy
    pip3 install scipy

    # Openmpi
    cd /home/packages_np3
    tar -zxf openmpi-1.10.2.tar.gz
    cd openmpi-1.10.2
    ./configure --prefix=/home/opt/openmpi
    make
    make install

    # R
    apt-get install r-base -y
    R --slave -e 'install.packages("Rmpi", configure.args=c("--with-Rmpi-include=/home/opt/openmpi/include/", "--with-Rmpi-libpath=/home/opt/openmpi/lib/", "--with-Rmpi-type=OPENMPI", "--with-mpi=/home/opt/openmpi"))'
    R --slave -e 'install.packages("fastDummies")'
    R --slave -e 'install.packages("optparse")'
    R --slave -e 'install.packages("doParallel")'
    R --slave -e 'install.packages("/home/packages_np3/glmnet_2.0-18.tar.gz", type="source", repos=NULL)'
    R --slave -e 'install.packages("e1071")'
    R --slave -e 'install.packages("R.oo")'
    R --slave -e 'install.packages("BayesTree")'
    R --slave -e 'install.packages("stats")'
    R --slave -e 'install.packages("matrixStats")'
    R --slave -e 'install.packages("Matrix")'
    R --slave -e 'install.packages("abind")'
    R --slave -e 'install.packages("lars")'


    # FIRE
    cd /home/packages_np3/
    unzip -q FIRE-1.1a.zip
    cd FIRE-1.1a/
    chmod 775 configure
    ./configure
    make
    chmod +x fire.pl


    # MEME
    cd /home/packages_np3/
    mkdir -p meme
    tar zxf meme-5.1.0.tar.gz
    cd meme-5.1.0
    ./configure --prefix=/home/packages_np3/meme --with-url=http://meme-suite.org/ --enable-build-libxslt
    make
    make install

%files
    NetProphet3.0 /home/
    toy_example /home/
    packages_np3 /home/
